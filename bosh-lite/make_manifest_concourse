#!/bin/bash

set -eux

MY_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# This script expects to live one directory below the release directory.
RELEASE_DIR=$( cd ${MY_DIR}/.. && pwd )

# And that the release directory lives one directory below the workspace directory.
WORKSPACE_DIR="$( cd ${RELEASE_DIR}/.. && pwd )"

OUTPUT_FILE=${OUTPUT_FILE:?}

OK_COLOR='\033[1;32m'
ACTION_COLOR='\033[1;33m'
INFO_COLOR='\033[1;36m'
NO_COLOR='\033[0m'

# By default use 3 node stub
mysql_stub="cf-mysql-stub-spiff-3-node.yml"
# If any arguments were provided,
# see if there is a stub with the number of nodes provided.
# If not, assume the argument is not the number of nodes and continue.
if [[ $# -ne 0 ]] && [[ -f "${RELEASE_DIR}/bosh-lite/cf-mysql-stub-spiff-$1-node.yml" ]] ; then
  mysql_stub="cf-mysql-stub-spiff-$1-node.yml"
  echo -e "Using stub ${INFO_COLOR}${RELEASE_DIR}/bosh-lite/${mysql_stub}${NO_COLOR}"
  shift
fi

${RELEASE_DIR}/generate_deployment_manifest \
  warden \
  ${RELEASE_DIR}/templates/sample_stubs/sample_plans_stub.yml \
  ${RELEASE_DIR}/bosh-lite/${mysql_stub} \
  "$@" > ${WORKSPACE_DIR}/${OUTPUT_FILE}
