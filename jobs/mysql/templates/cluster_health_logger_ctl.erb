#!/bin/bash -e

source /var/vcap/packages/common/utils.sh

JOB_DIR=/var/vcap/jobs/mysql
CONFIG_DIR=${JOB_DIR}/config
RUN_DIR=/var/vcap/sys/run/mysql
PID_FILE=${RUN_DIR}/cluster_health_logger.pid
BIN_FILE=/var/vcap/packages/galera-healthcheck/bin/cluster-health-logger
OUTPUT_FILE=/var/vcap/sys/log/mysql/cluster_health.log

case $1 in

  start)
    echo "Starting cluster_health_logger..."
    pid_guard ${PID_FILE} "cluster_health_logger"
    mkdir -p ${RUN_DIR}
    echo $$ > ${PID_FILE}

    chown -R vcap:vcap ${RUN_DIR}

    touch ${OUTPUT_FILE}
    chown vcap:vcap ${OUTPUT_FILE}

    exec chpst -u vcap:vcap ${BIN_FILE} -configPath=${CONFIG_DIR}/cluster_health_logger_config.yml

    ;;

  stop)
    echo "stop script: stopping cluster_health_logger..."

    kill_and_wait ${PID_FILE}
    echo "stop script: completed stopping cluster_health_logger"
    ;;

  *)
    echo "Usage: cluster_health_logger_ctl {start|stop}"
    ;;

esac
