#!/bin/bash -e

LOG_DIR=/var/vcap/sys/log/mysql
LOG_FILE=$LOG_DIR/cluster_health.log
MARIADB_PACKAGE=/var/vcap/packages/mariadb
MYSQL_BIN=${MARIADB_PACKAGE}/bin/mysql
RUN_DIR=/var/vcap/sys/run/mysql
PID_FILE=${RUN_DIR}/cluster_health_logger.pid

echo $$ > ${PID_FILE}

while [ true ]; do

  echo "Timestamp: $(date)" >> ${LOG_FILE}

  ${MYSQL_BIN} -t -u<%= p('cf_mysql.mysql.admin_username') %> -p<%= p('cf_mysql.mysql.admin_password') %> -e \
    "SHOW STATUS WHERE Variable_name IN  ('wsrep_ready','wsrep_cluster_conf_id','wsrep_cluster_status','wsrep_connected','wsrep_local_state_comment','wsrep_local_recv_queue_avg','wsrep_flow_control_paused','wsrep_cert_deps_distance','wsrep_local_send_queue_avg');" \
    >> ${LOG_FILE}

  sleep <%= p('cf_mysql.mysql.cluster_health_log_interval') %>

done
