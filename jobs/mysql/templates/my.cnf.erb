<%
  base_folder = '/var/vcap/sys/run/mysql'
%>

[client]
port      = <%= p('port') %>
socket		= <%= "#{base_folder}/mysqld.sock" %>

[mysqld_safe]
nice      = 0

[mysqld]
# Regular MYSQL options:
collation_server        = utf8_unicode_ci
character_set_server    = utf8
user		= vcap
socket		= <%= "#{base_folder}/mysqld.sock" %>
port      = <%= p('port') %>
basedir		= /var/vcap/packages/mariadb
datadir		= /var/vcap/store/mysql
tmpdir		= /var/vcap/data/mysql/tmp
language	= /var/vcap/packages/mariadb/share/english
pid-file  = /var/vcap/sys/run/mysql/mysql.pid
log_error = /var/vcap/sys/log/mysql/mysql.err.log
init_file = /var/vcap/jobs/mysql/config/mariadb_init
skip_external_locking = TRUE
max_allowed_packet = 256M
<% if_p('skip_name_resolve') do |disable_dns| %>
<%= "skip_name_resolve" if disable_dns %>
<% end %>
enforce_storage_engine = InnoDB

<% if p('binlog_enabled') %>
log_bin = mysql-bin
log_slave_updates = 1
expire_logs_days = <%= p('binlog_expire_days') %>
<% end %>

# Slow query logging:
slow_query_log = 1
slow_query_log_file = /var/vcap/sys/log/mysql/mysql_slow_query.log

innodb_file_per_table = ON
innodb_file_format = Barracuda
innodb_large_prefix = ON
innodb_log_file_size = "<%= p('ib_log_file_size')%>MB"
innodb_support_xa = OFF

max_heap_table_size = <%= p('max_heap_table_size') %>
tmp_table_size = <%= p('tmp_table_size') %>

# Audit logging
<% if_p('server_audit_events') do |server_audit_events| %>
plugin-load = server_audit=server_audit.so
server_audit_logging = ON
server_audit_events = <%= server_audit_events %>
server_audit_output_type = file
server_audit_file_path = /var/vcap/store/mysql_audit_logs/mysql_server_audit.log
server_audit_excl_users=<%= p('server_audit_excluded_users') %>
server_audit_file_rotations=0
<% end %>

# These are mandatory MySQL settings for MariaDB Galera to work
binlog_format = ROW
default_storage_engine = InnoDB
innodb_autoinc_lock_mode = 2
innodb_doublewrite = 1
query_cache_size = 0

# These are required to make the quota enforcer work
innodb_stats_on_metadata = ON
innodb_stats_persistent = OFF

<% if_p('innodb_lock_wait_timeout') do |innodb_lock_wait_timeout| %>
innodb_lock_wait_timeout = <%= innodb_lock_wait_timeout %>
<% end %>
<% if_p('innodb_buffer_pool_size') do |innodb_buffer_pool_size| %>
innodb_buffer_pool_size = <%= innodb_buffer_pool_size %>
<% end %>
<% if_p('innodb_buffer_pool_instances') do |innodb_buffer_pool_instances| %>
innodb_buffer_pool_instances = <%= innodb_buffer_pool_instances %>
<% end %>
innodb_flush_method=O_DIRECT

<% if_p('max_connections') do |max_connections| %>
max_connections = <%= max_connections %>
<% end %>

[mysqldump]
quick
quote-names
max_allowed_packet = 256M

[mysql]
max_allowed_packet = 256M

[isamchk]
key_buffer		= 16M
